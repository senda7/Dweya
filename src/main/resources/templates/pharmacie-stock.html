<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock de la Pharmacie | Dwaya</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a2e0e6fa41.js" crossorigin="anonymous"></script>
    <style>
        :root {
          --bg-gradient-start: #74ebd5;
          --bg-gradient-end: #ACB6E5;
          --container-bg: #ffffff;
          --primary-color: #1e6b77;
          --btn-bg: #74ebd5;
          --btn-hover: #5fc9bb;
          --text-color: #333;
        }

        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }

        body {
          font-family: 'Roboto', sans-serif;
          background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
          min-height: 100vh;
          padding-bottom: 40px;
        }

        /* Navbar */
        nav {
          position: sticky;
          top: 0;
          z-index: 1000;
          background-color: #fff;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 40px;
        }

        .logo-container {
          display: flex;
          align-items: center;
        }
        .logo {
          width: 110px;
          height: 110px;
          margin-bottom: 10px;
          animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-8px); }
        }

        .nav-links a {
          margin: 0 12px;
          text-decoration: none;
          color: var(--text-color);
          font-weight: 500;
          transition: color 0.3s;
        }

        .nav-links a:hover {
          color: var(--btn-hover);
        }

        .cart-icon {
          position: relative;
          margin-right: 20px;
          cursor: pointer;
        }

        .cart-count {
          position: absolute;
          top: -8px;
          right: -8px;
          background-color: var(--primary-color);
          color: white;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 12px;
        }

        .logout-btn {
          background-color: transparent;
          border: 2px solid var(--btn-bg);
          color: var(--btn-bg);
          padding: 8px 16px;
          border-radius: 8px;
          cursor: pointer;
          transition: 0.3s;
        }

        .logout-btn:hover {
          background-color: var(--btn-bg);
          color: white;
        }

        /* Panier flottant */
        .cart-sidebar {
          position: fixed;
          top: 0;
          right: -400px;
          width: 400px;
          height: 100vh;
          background: white;
          box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
          z-index: 1001;
          transition: right 0.3s ease;
          overflow-y: auto;
          padding: 20px;
        }

        .cart-sidebar.open {
          right: 0;
        }

        .cart-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          display: none;
        }

        .cart-overlay.open {
          display: block;
        }

        .cart-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 1px solid #eee;
        }

        .cart-items {
          margin-bottom: 20px;
        }

        .cart-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 15px;
          padding-bottom: 15px;
          border-bottom: 1px solid #eee;
        }

        .cart-item-info {
          flex: 1;
          position: relative;
        }

        .cart-item-price {
          font-weight: bold;
          min-width: 80px;
          text-align: right;
        }

        .cart-total {
          font-size: 18px;
          font-weight: bold;
          margin: 20px 0;
          text-align: right;
        }

        .checkout-btn {
          background: var(--primary-color);
          color: white;
          border: none;
          padding: 12px;
          border-radius: 8px;
          cursor: pointer;
          width: 100%;
          font-size: 16px;
          transition: background 0.3s;
        }

        .checkout-btn:hover {
          background: #155e63;
        }

        .checkout-btn:disabled {
          background: #ccc;
          cursor: not-allowed;
        }

        /* Contenu */
        .container {
          background-color: var(--container-bg);
          padding: 40px 30px;
          border-radius: 20px;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
          width: 100%;
          max-width: 1200px;
          margin: 30px auto;
        }

        .pharmacy-header {
          background: var(--btn-bg);
          color: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 25px;
        }

        .pharmacy-name {
          font-size: 28px;
          margin-bottom: 10px;
        }

        .pharmacy-info {
          margin-bottom: 5px;
        }

        .section-title {
          color: var(--primary-color);
          font-weight: bold;
          margin-bottom: 30px;
          text-align: center;
        }

        /* Search section */
        .search-section {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 25px;
        }

        .search-container {
          display: flex;
          gap: 15px;
        }

        .search-input {
          flex: 1;
          padding: 12px 15px;
          border: 1px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
        }

        /* Medicaments grid */
        .medicaments-container {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .medicament-card {
          background: white;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          transition: transform 0.3s;
        }

        .medicament-card:hover {
          transform: translateY(-5px);
        }

        .medicament-header {
          padding: 15px;
          background: var(--primary-color);
          color: white;
        }

        .medicament-name {
          font-size: 20px;
          margin-bottom: 5px;
        }

        .medicament-body {
          padding: 15px;
        }

        .medicament-info {
          margin-bottom: 10px;
        }

        .stock-low {
          color: #dc3545;
          font-weight: bold;
        }

        .stock-medium {
          color: #ffc107;
          font-weight: bold;
        }

        .stock-high {
          color: #28a745;
          font-weight: bold;
        }

        .add-to-cart-btn {
          display: block;
          width: 100%;
          padding: 10px;
          background: var(--primary-color);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          transition: background 0.3s;
          margin-top: 10px;
        }

        .add-to-cart-btn:hover {
          background: #155e63;
        }

        .add-to-cart-btn:disabled {
          background: #ccc;
          cursor: not-allowed;
        }

        .no-medicaments {
          text-align: center;
          padding: 40px;
          grid-column: 1 / -1;
          color: var(--primary-color);
          font-size: 18px;
        }

        .back-btn {
          background: var(--btn-bg);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .back-btn:hover {
          background: var(--btn-hover);
        }

        .medicament-image {
  width: 100%;
  height: 200px;
  object-fit: contain;
  border-radius: 8px;
  margin-bottom: 10px;
  background-color: transparent; /* Changement ici */
  padding: 10px;
}

        .medicament-image-placeholder {
  width: 100%;
  height: 200px;
  background-color: transparent; /* Changement ici */
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 10px;
  color: #6c757d;
  font-size: 48px;
}

        /* Nouveaux styles pour la gestion du panier */
        .cart-item-controls {
          display: flex;
          align-items: center;
          margin-top: 8px;
          flex-wrap: wrap;
          gap: 10px;
        }

        .quantity-control {
          display: flex;
          align-items: center;
        }

        .quantity-btn {
          width: 25px;
          height: 25px;
          background: var(--primary-color);
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
        }

        .quantity-input {
          width: 40px;
          height: 25px;
          text-align: center;
          margin: 0 5px;
          border: 1px solid #ddd;
          border-radius: 4px;
        }

        /* Style amélioré pour le bouton de suppression */
        .remove-btn {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
          border-radius: 4px;
          padding: 5px 10px;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          gap: 5px;
        }

        .remove-btn:hover {
          background: #f1b0b7;
          transform: scale(1.05);
        }

        .empty-cart-icon {
          font-size: 48px;
          color: #ddd;
          margin-bottom: 15px;
        }

        .empty-cart-message {
          text-align: center;
          padding: 20px;
          color: #777;
        }

        /* Style pour les notifications */
        .notification {
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          z-index: 2000;
          opacity: 0;
          transform: translateY(20px);
          transition: opacity 0.3s, transform 0.3s;
          max-width: 300px;
        }

        .notification.success {
          background: #28a745;
        }

        .notification.error {
          background: #dc3545;
        }

        .notification.show {
          opacity: 1;
          transform: translateY(0);
        }

        /* Loading state */
        .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255,255,255,.3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          nav {
            flex-direction: column;
            padding: 15px;
          }

          .nav-links {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
          }

          .nav-links a {
            margin: 5px;
          }

          .search-container {
            flex-direction: column;
          }

          .medicaments-container {
            grid-template-columns: 1fr;
          }

          .cart-sidebar {
            width: 100%;
            right: -100%;
          }

          .cart-item {
            flex-direction: column;
            gap: 10px;
          }

          .cart-item-controls {
            justify-content: space-between;
            margin-top: 10px;
          }

          .container {
            padding: 20px 15px;
          }
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav>
    <div class="logo-container">
        <img th:src="@{/logo.png}" src="https://via.placeholder.com/110x110/74ebd5/1e6b77?text=Dwaya" alt="Logo Dwaya" class="logo">
    </div>

    <div class="nav-links">
        <a th:href="@{/accueil-utilisateur}">Accueil</a>
        <a th:href="@{/medicament}">Médicaments</a>
        <a th:href="@{/rappels}">Rappels</a>
        <a th:href="@{/espace-dons}">Dons</a>
        <a th:href="@{/pharmacies}">Pharmacies</a>
        <a th:href="@{/profil-utilisateur}">Profil</a>
    </div>

    <div style="display: flex; align-items: center;">
        <!-- Icône du panier avec compteur -->
        <div class="cart-icon" id="cartIcon">
            <i class="fas fa-shopping-cart" style="font-size: 24px;"></i>
            <span class="cart-count" id="cartCount"><i class="fas fa-shopping-cart"></i></span>
        </div>

        <form th:action="@{/logout}" method="post">
            <button type="submit" class="logout-btn">Déconnexion</button>
        </form>
    </div>
</nav>

<!-- Panier flottant -->
<div class="cart-overlay" id="cartOverlay"></div>
<div class="cart-sidebar" id="cartSidebar">
    <div class="cart-header">
        <h3>Votre Panier</h3>
        <button id="closeCart" style="background: none; border: none; cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="cart-items" id="cartItems">
        <!-- Les éléments du panier seront ajoutés ici dynamiquement -->
    </div>

    <div class="cart-total">
        Total: <span id="cartTotal">0.000</span> TND
    </div>

    <button class="checkout-btn" id="checkoutBtn">Passer la commande</button>
</div>

<!-- Contenu de la page Stock -->
<div class="container">
    <!-- Bouton retour -->
    <button class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Retour aux pharmacies
    </button>

    <!-- En-tête de la pharmacie -->
    <div class="pharmacy-header">
        <h1 class="pharmacy-name" th:text="${pharmacie.nomPharmacie}">Nom Pharmacie</h1>
        <p class="pharmacy-info"><i class="fas fa-map-marker-alt"></i> <span th:text="${pharmacie.adresse} + ', ' + ${pharmacie.ville}">Adresse, Ville</span></p>
        <p class="pharmacy-info"><i class="fas fa-phone"></i> <span th:text="${pharmacie.telephone}">Téléphone</span></p>
        <p class="pharmacy-info"><i class="fas fa-envelope"></i> <span th:text="${pharmacie.email}">Email</span></p>
    </div>

    <h2 class="section-title">Médicaments disponibles </h2>

    <!-- Search Section -->
    <div class="search-section">
        <h3 class="search-title">Rechercher un médicament</h3>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Rechercher par nom de médicament..." id="medicamentSearch">
        </div>
    </div>

    <!-- Medicaments List -->
    <div class="medicaments-container" id="medicamentsList">
        <div th:if="${medicaments != null and medicaments.empty}" class="no-medicaments">
            <i class="fas fa-pills"></i> Aucun médicament en stock pour le moment.
        </div>

        <div th:if="${medicaments == null}" class="no-medicaments">
            <i class="fas fa-exclamation-triangle"></i> Erreur lors du chargement du stock.
        </div>

        <div th:each="medicament : ${medicaments}" class="medicament-card">
            <div class="medicament-header">
                <h3 class="medicament-name" th:text="${medicament.nom}">Nom Médicament</h3>
            </div>
            <div class="medicament-body">
                <!-- CORRECTION: Affichage correct de l'image avec vérification améliorée -->
                <div th:if="${medicament.photoData != null and medicament.photoData.length() > 0}">
                    <img th:src="'data:image/jpeg;base64,' + ${medicament.photoData}"
                         alt="Image du médicament"
                         class="medicament-image"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="medicament-image-placeholder" style="display: none;">
                        <i class="fas fa-pills"></i>
                    </div>
                </div>
                <div th:unless="${medicament.photoData != null and medicament.photoData.length() > 0}" class="medicament-image-placeholder">
                    <i class="fas fa-pills"></i>
                </div>

                <p class="medicament-info">Description: <span th:text="${medicament.description} ?: 'Aucune description disponible'">Description</span></p>
                <p class="medicament-info">Prix: <span th:text="${#numbers.formatDecimal(medicament.prix, 1, 2)} + ' TND'">Prix</span></p>
                <p class="medicament-info">
                    Stock:
                    <span th:class="${medicament.quantite <= 5} ? 'stock-low' :
                                      (${medicament.quantite <= 15} ? 'stock-medium' : 'stock-high')"
                          th:text="${medicament.quantite} + ' unités'">
                            Quantité
                        </span>
                </p>
                <p class="medicament-info" th:if="${medicament.ordonnanceRequise}">
                    <i class="fas fa-exclamation-triangle"></i> Ordonnance requise
                </p>
                <button class="add-to-cart-btn"
                        th:data-id="${medicament.id}"
                        th:data-name="${medicament.nom}"
                        th:data-price="${medicament.prix}"
                        th:data-max="${medicament.quantite}"
                        th:disabled="${medicament.quantite} <= 0">
                    <span th:if="${medicament.quantite} <= 0">Hors stock</span>
                    <span th:if="${medicament.quantite} > 0">
                        <i class="fas fa-cart-plus"></i> Ajouter au panier
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Gestion du panier
    let cart = [];

    // CORRECTION: Récupérer l'ID de la pharmacie depuis l'URL
    function getPharmacyIdFromUrl() {
      const pathParts = window.location.pathname.split('/');
      for (let i = 0; i < pathParts.length; i++) {
        if (pathParts[i] === 'pharmacie' && i + 1 < pathParts.length) {
          const id = parseInt(pathParts[i + 1]);
          if (!isNaN(id)) return id;
        }
      }
      return null;
    }

    const pharmacyId = getPharmacyIdFromUrl();

    // Vérifier si nous venons d'une commande réussie
    function checkOrderSuccess() {
      const urlParams = new URLSearchParams(window.location.search);
      const orderSuccess = urlParams.get('orderSuccess');

      if (orderSuccess === 'true') {
        // Vider le panier après une commande réussie
        clearCart();
        showNotification('Commande confirmée avec succès! Votre panier a été vidé.', 'success');

        // Nettoyer l'URL
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }
    }

    // Initialiser le panier depuis le localStorage
    function initCart() {
      if (pharmacyId) {
        const savedCart = localStorage.getItem(`cart_${pharmacyId}`);
        if (savedCart) {
          try {
            cart = JSON.parse(savedCart);
            updateCartUI();
          } catch (e) {
            console.error('Erreur lors du parsing du panier:', e);
            localStorage.removeItem(`cart_${pharmacyId}`);
          }
        }
      }
    }

    // Sauvegarder le panier dans le localStorage
    function saveCart() {
      if (pharmacyId) {
        localStorage.setItem(`cart_${pharmacyId}`, JSON.stringify(cart));
      }
    }

    // Vider complètement le panier
    function clearCart() {
      cart = [];
      saveCart();
      updateCartUI();
    }

    // Fonction pour afficher les notifications
    function showNotification(message, type = 'success') {
      // Créer la notification si elle n'existe pas
      let notification = document.getElementById('notification');
      if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `notification ${type}`;
        document.body.appendChild(notification);
      } else {
        notification.className = `notification ${type}`;
      }

      notification.textContent = message;
      notification.classList.add('show');

      // Cacher après 3 secondes
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Ajouter un médicament au panier
    function addToCart(id, name, price, maxQuantity) {
      // Vérifier si le médicament est déjà dans le panier
      const existingItem = cart.find(item => item.id == id);

      if (existingItem) {
        if (existingItem.quantity < maxQuantity) {
          existingItem.quantity += 1;
          showNotification(`Quantité de "${name}" augmentée dans le panier`);
        } else {
          showNotification(`Vous ne pouvez pas ajouter plus de ${maxQuantity} unités de ce médicament.`, 'error');
          return;
        }
      } else {
        cart.push({
          id: id,
          name: name,
          price: price,
          quantity: 1,
          maxQuantity: maxQuantity
        });
        showNotification(`"${name}" ajouté au panier`);
      }

      saveCart();
      updateCartUI();
    }

    // Mettre à jour la quantité d'un article
    function updateQuantity(id, newQuantity) {
      const item = cart.find(item => item.id == id);
      if (item) {
        if (newQuantity <= 0) {
          removeFromCart(id);
          return;
        }

        if (newQuantity > item.maxQuantity) {
          showNotification(`Vous ne pouvez pas ajouter plus de ${item.maxQuantity} unités de ce médicament.`, 'error');
          newQuantity = item.maxQuantity;
        }

        item.quantity = newQuantity;
        saveCart();
        updateCartUI();
      }
    }

    // Supprimer un article du panier SANS alerte de confirmation
    function removeFromCart(id) {
      const item = cart.find(item => item.id == id);
      if (item) {
        cart = cart.filter(item => item.id != id);
        saveCart();
        updateCartUI();

        // Afficher un message de confirmation
        showNotification(`"${item.name}" a été retiré du panier`, 'success');
      }
    }

    // Mettre à jour l'interface du panier
    function updateCartUI() {
      const cartCount = document.getElementById('cartCount');
      const cartItems = document.getElementById('cartItems');
      const cartTotal = document.getElementById('cartTotal');
      const checkoutBtn = document.getElementById('checkoutBtn');

      // Mettre à jour le compteur
      const totalItems = cart.reduce((total, item) => total + item.quantity, 0);

      // Afficher l'icône de chariot si le panier est vide, sinon le nombre d'articles
      if (totalItems === 0) {
        cartCount.innerHTML = '<i class="fas fa-shopping-cart"></i>';
        if (checkoutBtn) checkoutBtn.disabled = true;
      } else {
        cartCount.textContent = totalItems;
        if (checkoutBtn) checkoutBtn.disabled = false;
      }

      // Mettre à jour la liste des articles
      if (cartItems) {
        cartItems.innerHTML = '';
        let totalPrice = 0;

        if (cart.length === 0) {
          cartItems.innerHTML = `
            <div class="empty-cart-message">
              <div class="empty-cart-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <p>Votre panier est vide</p>
            </div>
          `;
        } else {
          cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            totalPrice += itemTotal;

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
              <div class="cart-item-info">
                <div><strong>${item.name}</strong></div>
                <div>${item.price} TND x ${item.quantity}</div>
                <div class="cart-item-controls">
                  <div class="quantity-control">
                    <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                    <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${item.maxQuantity}"
                      onchange="updateQuantity(${item.id}, parseInt(this.value))">
                    <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                  </div>
                  <button class="remove-btn" onclick="removeFromCart(${item.id})" title="Retirer du panier">
                    <i class="fas fa-trash-alt"></i> Supprimer
                  </button>
                </div>
              </div>
              <div class="cart-item-price">
                ${itemTotal.toFixed(3)} TND
              </div>
            `;

            cartItems.appendChild(cartItem);
          });
        }

        // Mettre à jour le total
        if (cartTotal) {
          cartTotal.textContent = totalPrice.toFixed(3);
        }
      }
    }

    // Gestion des événements
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page chargée, pharmacyId:', pharmacyId);

      // Vérifier si nous venons d'une commande réussie
      checkOrderSuccess();

      // Initialiser le panier
      initCart();

      // Boutons "Ajouter au panier"
      const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
      addToCartButtons.forEach(button => {
        button.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const name = this.getAttribute('data-name');
          const price = parseFloat(this.getAttribute('data-price'));
          const maxQuantity = parseInt(this.getAttribute('data-max'));

          addToCart(id, name, price, maxQuantity);
        });
      });

      // Ouvrir le panier
      const cartIcon = document.getElementById('cartIcon');
      if (cartIcon) {
        cartIcon.addEventListener('click', function() {
          document.getElementById('cartSidebar').classList.add('open');
          document.getElementById('cartOverlay').classList.add('open');
        });
      }

      // Fermer le panier
      const closeCart = document.getElementById('closeCart');
      if (closeCart) {
        closeCart.addEventListener('click', closeCartPanel);
      }

      const cartOverlay = document.getElementById('cartOverlay');
      if (cartOverlay) {
        cartOverlay.addEventListener('click', closeCartPanel);
      }

      // Passer la commande - VERSION CORRIGÉE
      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', function() {
          if (cart.length === 0) {
            showNotification('Votre panier est vide.', 'error');
            return;
          }

          // Construction des paramètres de la commande
          const queryParams = [];

          // Ajouter l'ID de la pharmacie
          queryParams.push(`pharmacieId=${pharmacyId}`);

          // Ajouter chaque médicament avec sa quantité
          cart.forEach(item => {
            queryParams.push(`medicamentIds=${item.id}`);
            queryParams.push(`quantites=${item.quantity}`);
          });

          // Rediriger directement vers la page de commande sans confirmation
          window.location.href = `/commander-panier?${queryParams.join('&')}`;
        });
      }

      // Filtrage des médicaments côté client
      const medicamentSearch = document.getElementById('medicamentSearch');
      if (medicamentSearch) {
        const medicamentCards = document.querySelectorAll('.medicament-card');

        function filterMedicaments() {
          const searchText = medicamentSearch.value.toLowerCase();

          medicamentCards.forEach(card => {
            const nameElement = card.querySelector('.medicament-name');
            const descriptionElement = card.querySelector('.medicament-info:nth-child(2)');

            if (nameElement && descriptionElement) {
              const name = nameElement.textContent.toLowerCase();
              const description = descriptionElement.textContent.toLowerCase();

              const matchesSearch = name.includes(searchText) || description.includes(searchText);

              if (matchesSearch) {
                card.style.display = 'block';
              } else {
                card.style.display = 'none';
              }
            }
          });
        }

        medicamentSearch.addEventListener('input', filterMedicaments);
      }
    });

    function closeCartPanel() {
      document.getElementById('cartSidebar').classList.remove('open');
      document.getElementById('cartOverlay').classList.remove('open');
    }
</script>
</body>
</html>